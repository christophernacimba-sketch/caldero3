<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Caldero BLE</title>

<style>
body {
  background: #111;
  color: #eee;
  font-family: Arial, sans-serif;
}

.panel {
  width: 420px;
  margin: 20px auto;
  padding: 15px;
  background: #1c1c1c;
  border-radius: 10px;
  box-shadow: 0 0 12px rgba(0,0,0,0.7);
}

h2, h3 {
  text-align: center;
  margin-bottom: 10px;
}

.section {
  margin-bottom: 15px;
}

button {
  padding: 8px 10px;
  margin: 4px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}

.btn-blue { background: #2980b9; color: #fff; }
.btn-purple { background: #8e44ad; color: #fff; }
.btn-green { background: #27ae60; color: #fff; }
.btn-red { background: #c0392b; color: #fff; }

button:hover {
  opacity: 0.85;
}

/* -------- LEDS -------- */
.led {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: inline-block;
  margin-left: 8px;
  box-shadow: 0 0 6px rgba(0,0,0,0.6);
}

.led-off    { background: #555; }
.led-red    { background: #c0392b; }
.led-green  { background: #27ae60; }
.led-blue   { background: #2980b9; }
.led-purple { background: #8e44ad; }

/* -------- TERM√ìMETRO -------- */
.thermo {
  width: 100%;
  height: 20px;
  background: #333;
  border-radius: 10px;
  overflow: hidden;
}

.thermo-fill {
  height: 100%;
  width: 0%;
  background: #27ae60;
  transition: width 0.5s;
}

/* -------- HIST√ìRICO -------- */
#historico {
  width: 100%;
  height: 120px;
  background: #000;
  color: #0f0;
  font-family: monospace;
  padding: 6px;
}
</style>
</head>

<body>

<div class="panel">
  <h2>üî• Control Caldero</h2>

  <!-- CONEXI√ìN BLE -->
  <div class="section" style="text-align:center;">
    <button class="btn-blue" onclick="connectBLE()">Conectar Bluetooth</button>
  </div>

  <!-- TERM√ìMETRO -->
  <div class="section">
    <strong>Temperatura</strong>
    <div class="thermo">
      <div id="thermoFill" class="thermo-fill"></div>
    </div>
    <div id="tempText">-- ¬∞C</div>
  </div>

  <!-- MODO -->
  <div class="section">
    <strong>Modo</strong>
    <span id="ledModo" class="led led-blue"></span><br>
    <button class="btn-blue" onclick="setModo('AUTO')">AUTOM√ÅTICO</button>
    <button class="btn-purple" onclick="setModo('MANUAL')">MANUAL</button>
  </div>

  <!-- ELECTROV√ÅLVULA -->
  <div class="section">
    <strong>Electrov√°lvula</strong>
    <span id="ledEV" class="led led-red"></span><br>
    <button class="btn-green" onclick="controlEV('ON')">ON</button>
    <button class="btn-red" onclick="controlEV('OFF')">OFF</button>
  </div>

  <!-- HIST√ìRICO -->
  <div class="section">
    <strong>Hist√≥rico</strong>
    <textarea id="historico" readonly></textarea>
    <button class="btn-blue" style="width:100%;" onclick="descargarHistorico()">
      Descargar hist√≥rico
    </button>
  </div>
</div>

<script>
let device, server, rxChar, txChar;

// UUIDs (los mismos de tu ESP32)
const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const TX_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
const RX_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

// -------- BLE --------
async function connectBLE() {
  device = await navigator.bluetooth.requestDevice({
    filters: [{ name: "ESP32_CONTROL_NIVEL" }],
    optionalServices: [SERVICE_UUID]
  });

  server = await device.gatt.connect();
  const service = await server.getPrimaryService(SERVICE_UUID);

  txChar = await service.getCharacteristic(TX_UUID);
  rxChar = await service.getCharacteristic(RX_UUID);

  await txChar.startNotifications();
  txChar.addEventListener("characteristicvaluechanged", onData);

  log("Bluetooth conectado");
}

function sendBLE(cmd) {
  if (!rxChar) return;
  rxChar.writeValue(new TextEncoder().encode(cmd));
}

// -------- RECEPCI√ìN DATOS --------
function onData(event) {
  const data = new TextDecoder().decode(event.target.value);
  log(data);

  const tempMatch = data.match(/TEMP:([\d.]+)/);
  if (tempMatch) updateTemp(parseFloat(tempMatch[1]));

  if (data.includes("MODO:MANUAL")) setLedModo("MANUAL");
  if (data.includes("MODO:AUTO")) setLedModo("AUTO");

  if (data.includes("EV:ON")) setLedEV("ON");
  if (data.includes("EV:OFF")) setLedEV("OFF");
}

// -------- CONTROLES --------
function setModo(modo) {
  sendBLE(modo === "AUTO" ? "MODE_AUTO" : "MODE_MANUAL");
}

function controlEV(state) {
  sendBLE(state === "ON" ? "EV_ON" : "EV_OFF");
}

// -------- INDICADORES --------
function setLedModo(modo) {
  const led = document.getElementById("ledModo");
  led.className = "led " + (modo === "AUTO" ? "led-blue" : "led-purple");
}

function setLedEV(state) {
  const led = document.getElementById("ledEV");
  led.className = "led " + (state === "ON" ? "led-green" : "led-red");
}

// -------- TERM√ìMETRO --------
function updateTemp(temp) {
  document.getElementById("tempText").textContent = temp + " ¬∞C";
  const percent = Math.min(100, temp);
  document.getElementById("thermoFill").style.width = percent + "%";
}

// -------- HIST√ìRICO --------
function log(text) {
  const h = document.getElementById("historico");
  const t = new Date().toLocaleTimeString();
  h.value += `[${t}] ${text}\n`;
  h.scrollTop = h.scrollHeight;
}

function descargarHistorico() {
  const data = document.getElementById("historico").value;
  const blob = new Blob([data], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "historico_caldero.txt";
  a.click();
}
</script>

</body>
</html>
